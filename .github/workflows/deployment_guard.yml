name: Org-Wide Deployment Guard

on:
  workflow_call:
    inputs:
      token:
        description: "GitHub token for accessing org variables"
        required: true
        type: string
    outputs:
      allow:
        description: "Whether deployment is allowed"
        value: ${{ jobs.check.outputs.allow }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      allow: ${{ steps.guard-check.outputs.allow }}
    steps:
      - id: guard-check
        shell: bash
        env:
          GITHUB_TOKEN: ${{ inputs.token }}
        run: |
          # Read org variable using the token (already accessible in vars)
          DEPLOY_VAR="${{ vars.ALLOW_DEPLOYMENT }}"

          # Normalize (lowercase, trim)
          DEPLOY_VAR_LOWER=$(echo "$DEPLOY_VAR" | tr '[:upper:]' '[:lower:]' | xargs)

          echo "Org variable value (normalized): '$DEPLOY_VAR_LOWER'"

          # Block only if explicitly "false"
          if [ "$DEPLOY_VAR_LOWER" = "false" ]; then
            echo "allow=false" >> "$GITHUB_OUTPUT"
            echo "ðŸš« Deployment blocked by org guard!"
          else
            echo "allow=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Deployment allowed"
          fi
